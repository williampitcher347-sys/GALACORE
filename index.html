<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBt_mZIfYnzcMygeQ11OTv1J59ARqsoN2c",
  databaseURL: "https://dcrd3upgraded-default-rtdb.firebaseio.com",
  projectId: "dcrd3upgraded"
});
const db = firebase.database();

/* ELEMENTS */
const nameScreen = document.getElementById("nameScreen");
const app = document.getElementById("app");
const nameInput = document.getElementById("nameInput");
const messages = document.getElementById("messages");
const users = document.getElementById("users");
const msg = document.getElementById("msg");
const voiceStatus = document.getElementById("voiceStatus");

/* SESSION */
let id = localStorage.getItem("galaxacord_id");
if (!id) {
  id = crypto.randomUUID();
  localStorage.setItem("galaxacord_id", id);
}

let username = localStorage.getItem("galaxacord_name");
let currentVoice = null;
let stream = null;

/* AUTO START */
if (username) start();

/* ENTER APP */
function enter() {
  const name = nameInput.value.trim();
  if (name.length < 3) {
    alert("Username must be at least 3 characters");
    return;
  }

  username = name;
  localStorage.setItem("galaxacord_name", name);

  db.ref("users/" + id).set({
    username,
    online: true
  });

  start();
}

/* START APP */
function start() {
  nameScreen.classList.add("hidden");
  app.classList.remove("hidden");

  setOnline();
  loadMessages();
  loadUsers();
}

/* ONLINE */
function setOnline() {
  db.ref("users/" + id + "/online").set(true);

  window.onbeforeunload = () => {
    db.ref("users/" + id).remove();
    leaveVoice();
  };
}

/* CHAT */
function send() {
  if (!msg.value) return;

  db.ref("messages").push({
    user: username,
    text: msg.value
  });

  msg.value = "";
}

function loadMessages() {
  messages.innerHTML = "";
  db.ref("messages").limitToLast(100).on("child_added", snap => {
    const m = snap.val();
    const div = document.createElement("div");
    div.textContent = m.user + ": " + m.text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  });
}

/* USERS */
function loadUsers() {
  db.ref("users").on("value", snap => {
    users.innerHTML = "";
    snap.forEach(u => {
      if (!u.val().online) return;
      const div = document.createElement("div");
      div.className = "user";
      div.textContent = u.val().username;
      users.appendChild(div);
    });
  });
}

/* VOICE */
async function joinVoice(room) {
  if (currentVoice === room) return;
  leaveVoice();

  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  currentVoice = room;
  voiceStatus.textContent = "ðŸ”Š Connected to " + room;
}

function leaveVoice() {
  if (!currentVoice) return;

  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }

  currentVoice = null;
  voiceStatus.textContent = "Not in voice";
}
</script>
