<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Galaxacord</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { margin: 0; background: #1e1f22; color: white; height: 100vh; }

.hidden { display: none; }

button {
  background: #5865f2;
  border: none;
  color: white;
  padding: 10px;
  cursor: pointer;
}

input {
  padding: 10px;
  margin-top: 10px;
  width: 100%;
}

#usernameScreen {
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.box {
  background: #2b2d31;
  padding: 25px;
  width: 320px;
  border-radius: 8px;
}

#app {
  display: grid;
  grid-template-columns: 70px 240px 1fr 240px;
  height: 100vh;
}

.servers { background: #1e1f22; padding: 10px; }
.channels { background: #2b2d31; padding: 10px; }
.chat { background: #313338; display: flex; flex-direction: column; }
.messages { flex: 1; overflow-y: auto; padding: 10px; }
.input { display: flex; }
.input input { flex: 1; }
.members { background: #2b2d31; padding: 10px; }

.user { padding: 4px; font-size: 14px; }

.voiceBox {
  margin-top: 10px;
  background: #232428;
  padding: 8px;
}
</style>
</head>
<body>

<!-- USERNAME PICK -->
<div id="usernameScreen">
  <div class="box">
    <h2>Galaxacord</h2>
    <input id="usernameInput" placeholder="Choose a username">
    <button onclick="enterApp()">Enter</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="servers">ðŸŒŒ</div>

  <div class="channels">
    <h4>Text</h4>
    <div># global</div>

    <h4>Voice</h4>
    <div onclick="joinVoice('VC-1')">ðŸ”Š VC-1</div>
    <div onclick="joinVoice('VC-2')">ðŸ”Š VC-2</div>

    <div class="voiceBox">
      <div id="voiceStatus">Not in voice</div>
      <button onclick="leaveVoice()">Disconnect</button>
    </div>
  </div>

  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="input">
      <input id="msg" placeholder="Message">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <div class="members">
    <h4>Online</h4>
    <div id="users"></div>
  </div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBt_mZIfYnzcMygeQ11OTv1J59ARqsoN2c",
  databaseURL: "https://dcrd3upgraded-default-rtdb.firebaseio.com",
  projectId: "dcrd3upgraded"
});

const db = firebase.database();

/* SESSION */
let sessionId = localStorage.getItem("galaxacord_id");
if (!sessionId) {
  sessionId = crypto.randomUUID();
  localStorage.setItem("galaxacord_id", sessionId);
}

let username = localStorage.getItem("galaxacord_name");
let currentVoice = null;
let localStream = null;

/* AUTO JOIN */
if (username) startApp();

/* ENTER */
function enterApp() {
  const name = usernameInput.value.trim();
  if (name.length < 3) return alert("Username too short");

  username = name;
  localStorage.setItem("galaxacord_name", name);

  db.ref("users/" + sessionId).set({
    username,
    online: true
  });

  startApp();
}

/* START */
function startApp() {
  usernameScreen.classList.add("hidden");
  app.classList.remove("hidden");

  setOnline();
  loadChat();
  loadUsers();
}

/* ONLINE */
function setOnline() {
  db.ref("users/" + sessionId + "/online").set(true);
  window.onbeforeunload = () => {
    db.ref("users/" + sessionId).remove();
    leaveVoice();
  };
}

/* CHAT */
function sendMessage() {
  if (!msg.value) return;
  db.ref("messages").push({
    user: username,
    text: msg.value
  });
  msg.value = "";
}

function loadChat() {
  messages.innerHTML = "";
  db.ref("messages").limitToLast(100).on("child_added", snap => {
    const m = snap.val();
    const d = document.createElement("div");
    d.textContent = m.user + ": " + m.text;
    messages.appendChild(d);
    messages.scrollTop = messages.scrollHeight;
  });
}

/* USERS */
function loadUsers() {
  db.ref("users").on("value", snap => {
    users.innerHTML = "";
    snap.forEach(u => {
      if (!u.val().online) return;
      const d = document.createElement("div");
      d.className = "user";
      d.textContent = u.val().username;
      users.appendChild(d);
    });
  });
}

/* VOICE */
async function joinVoice(room) {
  if (currentVoice === room) return;
  leaveVoice();

  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  currentVoice = room;

  voiceStatus.textContent = "ðŸ”Š Connected to " + room;
}

function leaveVoice() {
  if (!currentVoice) return;

  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }

  currentVoice = null;
  voiceStatus.textContent = "Not in voice";
}
</script>
</body>
</html>
