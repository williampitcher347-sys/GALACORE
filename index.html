<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Galaxacord</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body { margin:0; font-family:Arial; background:#1e1f22; color:white }
.hidden { display:none }

#auth {
  height:100vh; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:8px
}
input, button {
  width:260px; padding:10px; border:none; border-radius:5px
}
button { background:#5865f2; color:white; cursor:pointer }
#error { color:#ff5555 }

#app { display:flex; height:100vh }
#sidebar {
  width:260px; background:#2b2d31; padding:10px
}
#main {
  flex:1; background:#313338;
  display:flex; flex-direction:column
}
#messages { flex:1; padding:10px; overflow-y:auto }
#msg { padding:10px; border:none; background:#383a40; color:white }

.friend { padding:6px; cursor:pointer }
.friend:hover { background:#3f4147 }

.voice {
  margin-top:10px;
  padding:8px;
  background:#202225;
  cursor:pointer;
}
.voice.active { background:#3ba55d }
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth">
  <h1>Galaxacord</h1>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <input id="username" placeholder="Username (register)">
  <button onclick="register()">Register</button>
  <button onclick="login()">Login</button>
  <p id="error"></p>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div id="sidebar">
    <h3 id="me"></h3>

    <div class="voice" id="voiceBtn" onclick="toggleVoice()">
      ðŸ”Š Global Voice
    </div>

    <input id="friendInput" placeholder="username#tag">
    <button onclick="addFriend()">Add Friend</button>

    <h4>Friends</h4>
    <div id="friends"></div>
  </div>

  <div id="main">
    <div id="messages"></div>
    <input id="msg" placeholder="Message" onkeydown="if(event.key==='Enter')sendMsg()">
  </div>
</div>

<script>
/* ðŸ”¥ BRAND NEW FIREBASE PROJECT CONFIG ðŸ”¥ */
firebase.initializeApp({
  apiKey: "AIzaSyCgD_YaDaGAgRdY4RJIRO_6JP20S68Y6aA",
  authDomain: "dcrd2-27614.firebaseapp.com",
  databaseURL: "https://dcrd2-27614-default-rtdb.firebaseio.com",
  projectId: "dcrd2-27614",
  storageBucket: "dcrd2-27614.firebasestorage.app",
  messagingSenderId: "502344350795",
  appId: "1:502344350795:web:086eaaf15aa5355d3361ce"
});

const auth = firebase.auth();
const db = firebase.database();

let currentChat = null;
let localStream = null;
let peers = {};
let inVoice = false;

/* AUTH STATE */
auth.onAuthStateChanged(user => {
  if (user) {
    authDiv.style.display = "none";
    app.classList.remove("hidden");
    loadMe();
    loadFriends();
  } else {
    authDiv.style.display = "flex";
    app.classList.add("hidden");
  }
});

const authDiv = document.getElementById("auth");

/* REGISTER */
function register() {
  if (!username.value) return error.innerText = "Username required";

  auth.createUserWithEmailAndPassword(email.value, password.value)
    .then(res => {
      const tag = "#" + Math.floor(1000 + Math.random()*9000);
      return db.ref("users/" + res.user.uid).set({
        username: username.value,
        tag
      });
    })
    .catch(e => error.innerText = e.message);
}

/* LOGIN */
function login() {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(e => error.innerText = e.message);
}

/* PROFILE */
function loadMe() {
  db.ref("users/" + auth.currentUser.uid).once("value").then(s => {
    me.innerText = s.val().username + s.val().tag;
  });
}

/* FRIENDS */
function addFriend() {
  const val = friendInput.value;
  if (!val.includes("#")) return;

  const [name, tag] = val.split("#");

  db.ref("users").once("value").then(snap => {
    snap.forEach(u => {
      if (u.val().username === name && u.val().tag === "#" + tag) {
        const uid = auth.currentUser.uid;
        db.ref("friends/" + uid + "/" + u.key).set(true);
        db.ref("friends/" + u.key + "/" + uid).set(true);
      }
    });
  });

  friendInput.value = "";
}

function loadFriends() {
  const uid = auth.currentUser.uid;
  db.ref("friends/" + uid).on("value", snap => {
    friends.innerHTML = "";
    snap.forEach(f => {
      db.ref("users/" + f.key).once("value").then(u => {
        const d = document.createElement("div");
        d.className = "friend";
        d.innerText = u.val().username + u.val().tag;
        d.onclick = () => openDM(f.key);
        friends.appendChild(d);
      });
    });
  });
}

/* DMS */
function openDM(other) {
  currentChat = [auth.currentUser.uid, other].sort().join("_");
  messages.innerHTML = "";

  db.ref("messages/" + currentChat).off();
  db.ref("messages/" + currentChat).on("child_added", s => {
    const d = document.createElement("div");
    d.innerText = s.val().text;
    messages.appendChild(d);
  });
}

function sendMsg() {
  if (!currentChat || !msg.value) return;
  db.ref("messages/" + currentChat).push({
    text: msg.value,
    sender: auth.currentUser.uid,
    time: Date.now()
  });
  msg.value = "";
}

/* ðŸ”Š VOICE CHAT (WEBRTC) */
async function toggleVoice() {
  if (inVoice) leaveVoice();
  else joinVoice();
}

async function joinVoice() {
  inVoice = true;
  voiceBtn.classList.add("active");

  localStream = await navigator.mediaDevices.getUserMedia({ audio:true });

  const uid = auth.currentUser.uid;
  const room = "global";

  const roomRef = db.ref("voice/" + room + "/" + uid);
  roomRef.set(true);
  roomRef.onDisconnect().remove();

  db.ref("voice/" + room).on("child_added", snap => {
    if (snap.key !== uid) createPeer(snap.key, true);
  });
}

function leaveVoice() {
  inVoice = false;
  voiceBtn.classList.remove("active");

  Object.values(peers).forEach(p => p.close());
  peers = {};

  db.ref("voice/global/" + auth.currentUser.uid).remove();
}

function createPeer(peerId, initiator) {
  const pc = new RTCPeerConnection();
  peers[peerId] = pc;

  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  pc.ontrack = e => {
    const a = new Audio();
    a.srcObject = e.streams[0];
    a.autoplay = true;
  };

  const ref = db.ref("signals/global/" + peerId + "/" + auth.currentUser.uid);

  pc.onicecandidate = e => e.candidate && ref.push({ ice:e.candidate });

  if (initiator) {
    pc.createOffer().then(o => {
      pc.setLocalDescription(o);
      ref.push({ offer:o });
    });
  }

  db.ref("signals/global/" + auth.currentUser.uid + "/" + peerId)
    .on("child_added", async snap => {
      const d = snap.val();
      if (d.offer) {
        await pc.setRemoteDescription(d.offer);
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        ref.push({ answer:ans });
      }
      if (d.answer) await pc.setRemoteDescription(d.answer);
      if (d.ice) await pc.addIceCandidate(d.ice);
    });
}
</script>

</body>
</html>
