<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Galaxacord</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { margin: 0; background: #1e1f22; color: white; height: 100vh; overflow: hidden; }

.hidden { display: none; }

#auth {
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.auth-box {
  background: #2b2d31;
  padding: 30px;
  width: 320px;
  border-radius: 8px;
}

.auth-box input, .auth-box button {
  width: 100%;
  margin-top: 10px;
  padding: 10px;
}

button {
  background: #5865f2;
  color: white;
  border: none;
  cursor: pointer;
}

#app {
  display: grid;
  grid-template-columns: 70px 240px 1fr 240px;
  height: 100vh;
}

.servers {
  background: #1e1f22;
  padding: 10px;
}

.channels {
  background: #2b2d31;
  padding: 10px;
}

.chat {
  background: #313338;
  display: flex;
  flex-direction: column;
}

.messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

.input {
  display: flex;
}

.input input {
  flex: 1;
  padding: 10px;
}

.members {
  background: #2b2d31;
  padding: 10px;
}

.voice {
  background: #232428;
  padding: 10px;
}

.user {
  padding: 5px;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth">
  <div class="auth-box">
    <h2 id="authTitle">Login</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <input id="username" placeholder="Username (register only)">
    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="servers">ðŸŒŒ</div>
  <div class="channels">
    <h4>Text</h4>
    <div># global</div>
    <h4>Voice</h4>
    <div onclick="joinVoice('vc1')">ðŸ”Š VC 1</div>
    <div onclick="joinVoice('vc2')">ðŸ”Š VC 2</div>
  </div>
  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="input">
      <input id="msg" placeholder="Message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
  <div class="members">
    <h4>Online</h4>
    <div id="users"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBt_mZIfYnzcMygeQ11OTv1J59ARqsoN2c",
  authDomain: "dcrd3upgraded.firebaseapp.com",
  projectId: "dcrd3upgraded",
  databaseURL: "https://dcrd3upgraded-default-rtdb.firebaseio.com",
  storageBucket: "dcrd3upgraded.firebasestorage.app",
  messagingSenderId: "22145403485",
  appId: "1:22145403485:web:ec5ffdde4cebe37a7b1bb4"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser;
let localStream;
let peer;

auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById("auth").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    setOnline();
    loadChat();
    loadUsers();
  } else {
    document.getElementById("auth").classList.remove("hidden");
    document.getElementById("app").classList.add("hidden");
  }
});

function register() {
  const email = email.value;
  const pass = password.value;
  const name = username.value;

  auth.createUserWithEmailAndPassword(email, pass)
    .then(res => {
      const tag = Math.floor(1000 + Math.random() * 9000);
      db.ref("users/" + res.user.uid).set({
        username: name,
        tag,
        online: true
      });
      alert("Nice! Now log in.");
      auth.signOut();
    })
    .catch(e => alert(e.message));
}

function login() {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(e => alert(e.message));
}

function setOnline() {
  db.ref("users/" + currentUser.uid + "/online").set(true);
  window.onbeforeunload = () =>
    db.ref("users/" + currentUser.uid + "/online").set(false);
}

function sendMessage() {
  const text = msg.value;
  if (!text) return;
  db.ref("messages").push({
    uid: currentUser.uid,
    text,
    time: Date.now()
  });
  msg.value = "";
}

function loadChat() {
  db.ref("messages").limitToLast(100).on("child_added", snap => {
    const m = snap.val();
    const div = document.createElement("div");
    div.textContent = m.text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  });
}

function loadUsers() {
  db.ref("users").on("value", snap => {
    users.innerHTML = "";
    snap.forEach(u => {
      if (u.val().online) {
        const d = document.createElement("div");
        d.className = "user";
        d.textContent = u.val().username + "#" + u.val().tag;
        users.appendChild(d);
      }
    });
  });
}

/* BASIC VOICE CHAT */
async function joinVoice(room) {
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const audio = document.createElement("audio");
  audio.srcObject = localStream;
  audio.autoplay = true;
}
</script>
</body>
</html>
