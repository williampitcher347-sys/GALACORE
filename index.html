<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Galaxacord Voice Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  background: #1e1f22;
  color: white;
  font-family: Arial;
}
#ui {
  padding: 20px;
}
button {
  padding: 10px;
  background: #5865f2;
  border: none;
  color: white;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="ui">
  <h2>Galaxacord Voice</h2>
  <input id="name" placeholder="Username"><br><br>
  <button onclick="join()">Join Voice</button>
  <button onclick="leave()">Leave</button>
  <div id="status">Idle</div>
</div>

<script>
/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyBt_mZIfYnzcMygeQ11OTv1J59ARqsoN2c",
  databaseURL: "https://dcrd3upgraded-default-rtdb.firebaseio.com",
  projectId: "dcrd3upgraded"
});

const db = firebase.database();

/* ---------- USER ---------- */
const id = localStorage.getItem("id") || crypto.randomUUID();
localStorage.setItem("id", id);

/* ---------- WEBRTC ---------- */
let pc;
let stream;

const iceConfig = {
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

/* ---------- JOIN VOICE ---------- */
async function join() {
  document.getElementById("status").textContent = "Connectingâ€¦";

  stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  pc = new RTCPeerConnection(iceConfig);

  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  pc.ontrack = e => {
    const audio = document.createElement("audio");
    audio.srcObject = e.streams[0];
    audio.autoplay = true;
    document.body.appendChild(audio);
  };

  pc.onicecandidate = e => {
    if (e.candidate) {
      db.ref("voice/ice").push(JSON.stringify(e.candidate));
    }
  };

  db.ref("voice/ice").on("child_added", s => {
    const c = JSON.parse(s.val());
    pc.addIceCandidate(new RTCIceCandidate(c));
  });

  db.ref("voice/offer").once("value", async snap => {
    if (snap.exists()) {
      await pc.setRemoteDescription(
        new RTCSessionDescription(JSON.parse(snap.val()))
      );

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      db.ref("voice/answer").set(JSON.stringify(answer));
    } else {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      db.ref("voice/offer").set(JSON.stringify(offer));

      db.ref("voice/answer").on("value", async s => {
        if (s.exists() && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(
            new RTCSessionDescription(JSON.parse(s.val()))
          );
        }
      });
    }
  });

  document.getElementById("status").textContent = "ðŸ”Š In Voice";
}

/* ---------- LEAVE ---------- */
function leave() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  if (pc) pc.close();
  pc = null;
  db.ref("voice").remove();
  document.getElementById("status").textContent = "Disconnected";
}
</script>

</body>
</html>
