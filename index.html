<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Galaxacord</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase (safe load) -->
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body {
  margin: 0;
  background: #1e1f22;
  color: white;
  height: 100vh;
}

#app {
  display: grid;
  grid-template-columns: 70px 240px 1fr 240px;
  height: 100vh;
}

.servers { background: #1e1f22; padding: 10px; }
.channels { background: #2b2d31; padding: 10px; }
.chat { background: #313338; display: flex; flex-direction: column; }
.messages { flex: 1; overflow-y: auto; padding: 10px; }
.input { display: flex; gap: 5px; padding: 10px; }
.members { background: #2b2d31; padding: 10px; }

button {
  background: #5865f2;
  border: none;
  color: white;
  padding: 8px;
  cursor: pointer;
}

input {
  padding: 8px;
  width: 100%;
}
</style>
</head>

<body>

<!-- UI RENDERS NO MATTER WHAT -->
<div id="app">
  <div class="servers">ðŸŒŒ</div>

  <div class="channels">
    <h4>Text</h4>
    <div># global</div>

    <h4>Voice</h4>
    <div onclick="joinVoice('VC-1')">ðŸ”Š VC-1</div>
    <div onclick="joinVoice('VC-2')">ðŸ”Š VC-2</div>

    <hr>
    <div id="voiceStatus">Not in voice</div>
    <button onclick="leaveVoice()">Disconnect</button>

    <hr>
    <input id="nameInput" placeholder="Username">
    <button onclick="changeName()">Save Name</button>
  </div>

  <div class="chat">
    <div class="messages" id="messages">
      <div>Welcome to Galaxacord ðŸ‘‹</div>
    </div>
    <div class="input">
      <input id="msg" placeholder="Message">
      <button onclick="send()">Send</button>
    </div>
  </div>

  <div class="members">
    <h4>Online</h4>
    <div id="users">Loadingâ€¦</div>
  </div>
</div>

<script>
/* ---------- SAFE START ---------- */
let db = null;

/* USER */
let id = localStorage.getItem("gc_id") || crypto.randomUUID();
localStorage.setItem("gc_id", id);

let username = localStorage.getItem("gc_name");
if (!username) {
  username = "User" + Math.floor(Math.random() * 9000);
  localStorage.setItem("gc_name", username);
}
document.getElementById("nameInput").value = username;

/* VOICE */
let stream = null;
let currentVoice = null;

/* FIREBASE INIT (SAFE) */
window.addEventListener("load", () => {
  try {
    firebase.initializeApp({
      apiKey: "AIzaSyBt_mZIfYnzcMygeQ11OTv1J59ARqsoN2c",
      databaseURL: "https://dcrd3upgraded-default-rtdb.firebaseio.com",
      projectId: "dcrd3upgraded"
    });

    db = firebase.database();
    startFirebase();
  } catch (e) {
    console.error("Firebase failed:", e);
    document.getElementById("users").textContent =
      "Offline mode (Firebase failed)";
  }
});

/* FIREBASE LOGIC */
function startFirebase() {
  db.ref("users/" + id).set({ username, online: true });

  db.ref("users").on("value", snap => {
    const users = document.getElementById("users");
    users.innerHTML = "";
    snap.forEach(u => {
      const div = document.createElement("div");
      div.textContent = u.val().username;
      users.appendChild(div);
    });
  });

  db.ref("messages").limitToLast(50).on("child_added", s => {
    const m = s.val();
    const div = document.createElement("div");
    div.textContent = m.user + ": " + m.text;
    document.getElementById("messages").appendChild(div);
  });

  window.onbeforeunload = () => {
    db.ref("users/" + id).remove();
    leaveVoice();
  };
}

/* CHAT */
function send() {
  const input = document.getElementById("msg");
  if (!input.value || !db) return;
  db.ref("messages").push({ user: username, text: input.value });
  input.value = "";
}

/* NAME */
function changeName() {
  const v = document.getElementById("nameInput").value.trim();
  if (v.length < 3) return alert("Name too short");
  username = v;
  localStorage.setItem("gc_name", v);
  if (db) db.ref("users/" + id + "/username").set(v);
}

/* VOICE */
async function joinVoice(room) {
  leaveVoice();
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    currentVoice = room;
    document.getElementById("voiceStatus").textContent =
      "ðŸ”Š Connected to " + room;
  } catch {
    alert("Mic blocked");
  }
}

function leaveVoice() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
  currentVoice = null;
  document.getElementById("voiceStatus").textContent = "Not in voice";
}
</script>

</body>
</html>
